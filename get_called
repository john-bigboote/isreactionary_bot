import praw
import pdb
import re
import os

# external class which does the bulk of the work
from mainFun import User

# get reddit_username and reddit_password from local file login_details.py
from login_details import *

# set up the reddit api and log in
user_agent = ("isreactionary bot by numandina, "
              "this file checks if bot was called ")
r = praw.Reddit(user_agent = user_agent)
r.login(reddit_username, reddit_password)

# edit this to change subs being considered reactionary
suspicious_subs = ["anarchism", "metanarchism", "anarchy101",
                   "mensrights", "theredpill", "coontown",
                   "greatapes", "whiterights", "anarcho_capitalism",
                   "kotakuinaction"]

with open("messages_seen.txt", "r") as f:
    posts_replied_to = f.read()
    posts_replied_to = posts_replied_to.split("\n")
    posts_replied_to = filter(None, posts_replied_to)

for msg in r.get_mentions(limit=None):

    if msg.id not in posts_replied_to:
              
        posts_replied_to.append(msg.id)
        with open("messages_seen.txt", "w") as f:
            for post_id in posts_replied_to:
                f.write(post_id + "\n")

        msg.mark_as_read()
        username = msg.body[msg.body.find("/u/isreactionary_bot") + 21:]
        try:
            user = User(username, r, suspicious_subs, -99999)
            user.process_comments()
            user.process_submitted()

            info = user.get_monitoring_info()

            if len(info) > 0:
                info += "\n\n___\n\n^I'm ^a ^bot. ^Only ^the ^past ^1,000 ^comments ^are ^fetched."
                info.replace("http://www.", "http://np.")
                info = info[:10000]
                msg.upvote()
                msg.reply(info)
        except:
            pass
